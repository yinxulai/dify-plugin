# .github/workflows/publish.yml
name: Publish to Official Plugin Store

on:
  workflow_call:
    inputs:
      tag_name:
        description: 'Release tag name (e.g., ai-models-provider-v0.2.0)'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag name (e.g., ai-models-provider-v0.2.0)'
        required: true
        type: string

jobs:
  publish_to_store:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout plugin source code
        uses: actions/checkout@v4

      - name: Parse plugin info from tag
        id: parse_tag
        run: |
          TAG_NAME="${{ inputs.tag_name }}"
          echo "Processing tag: $TAG_NAME"
          
          # 解析插件名称和版本 (格式: plugin-name-vX.Y.Z 或 plugin-name-vX.Y.Z-beta.N)
          # 使用贪婪匹配提取插件名称（去掉 -vX.Y.Z... 部分）
          PLUGIN_NAME=$(echo "$TAG_NAME" | sed -E 's/-v[0-9]+\.[0-9]+\.[0-9]+.*//')
          # 提取完整版本号（包括预发布标识符）
          VERSION=$(echo "$TAG_NAME" | sed -E 's/^.*-v//')
          
          echo "Plugin name: $PLUGIN_NAME"
          echo "Version: $VERSION"
          
          echo "plugin_name=$PLUGIN_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # 确定插件路径和作者
          if [ "$PLUGIN_NAME" = "ai-models-provider" ] || [ "$PLUGIN_NAME" = "storage-tools" ]; then
            echo "plugin_path=$PLUGIN_NAME" >> $GITHUB_OUTPUT
            echo "author=yinxulai" >> $GITHUB_OUTPUT
            echo "plugin_owner=qiniu" >> $GITHUB_OUTPUT
          else
            echo "Error: Unknown plugin name: $PLUGIN_NAME"
            exit 1
          fi

      - name: Download plugin package from release
        run: |
          PACKAGE_NAME="${{ steps.parse_tag.outputs.plugin_name }}-${{ steps.parse_tag.outputs.version }}.difypkg"
          echo "Downloading package: $PACKAGE_NAME"
          
          # 从 release 下载打包文件
          gh release download ${{ inputs.tag_name }} \
            --pattern "$PACKAGE_NAME" \
            --repo ${{ github.repository }}
          
          # 验证文件已下载
          if [ ! -f "$PACKAGE_NAME" ]; then
            echo "Error: Failed to download package file"
            exit 1
          fi
          
          echo "Package downloaded successfully:"
          ls -lh "$PACKAGE_NAME"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Checkout official plugin store repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.parse_tag.outputs.author }}/dify-plugins
          path: dify-plugins
          token: ${{ secrets.PLUGIN_ACTION }}
          fetch-depth: 1
          persist-credentials: true

      - name: Commit and push to plugin store
        run: |
          PACKAGE_NAME="${{ steps.parse_tag.outputs.plugin_name }}-${{ steps.parse_tag.outputs.version }}.difypkg"
          echo "Moving package: $PACKAGE_NAME"

          # 将打包文件移动到目标目录（使用 plugin_owner 作为组织目录）
          mkdir -p dify-plugins/${{ steps.parse_tag.outputs.plugin_owner }}/${{ steps.parse_tag.outputs.plugin_name }}
          mv "$PACKAGE_NAME" dify-plugins/${{ steps.parse_tag.outputs.plugin_owner }}/${{ steps.parse_tag.outputs.plugin_name }}/

          # 进入目标仓库目录
          cd dify-plugins

          # 配置 git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # 确保我们在最新的 main 分支上
          git fetch origin main
          git checkout main
          git pull origin main

          # 创建并切换到新分支
          BRANCH_NAME="bump-${{ steps.parse_tag.outputs.plugin_name }}-plugin-${{ steps.parse_tag.outputs.version }}"
          git checkout -b "$BRANCH_NAME"

          # 添加并提交更改
          git add .
          git status
          git commit -m "bump ${{ steps.parse_tag.outputs.plugin_name }} plugin to version ${{ steps.parse_tag.outputs.version }}"

          # 推送到远程
          git push -u origin "$BRANCH_NAME" --force

          # 确认分支已推送并等待同步
          git branch -a
          echo "Waiting for branch to sync..."
          sleep 10

      - name: Create PR to official plugin store
        env:
          GH_TOKEN: ${{ secrets.PLUGIN_ACTION }}
        run: |
          gh pr create \
            --repo langgenius/dify-plugins \
            --head "${{ steps.parse_tag.outputs.author }}:bump-${{ steps.parse_tag.outputs.plugin_name }}-plugin-${{ steps.parse_tag.outputs.version }}" \
            --base main \
            --title "bump ${{ steps.parse_tag.outputs.plugin_name }} plugin to version ${{ steps.parse_tag.outputs.version }}" \
            --body "bump ${{ steps.parse_tag.outputs.plugin_name }} plugin package to version ${{ steps.parse_tag.outputs.version }}

            Changes:
            - Updated plugin package file
            
            ---
            This PR was automatically created by GitHub Actions." || echo "PR already exists or creation skipped."
