name: Runnable

on:
  push:
    branches: [ main, develop, 2.x ]
  pull_request:
    branches: [ main, develop, 2.x ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
        plugin:
          - name: "qiniu-ai-models"
            path: "qiniu-ai-models"
          - name: "qiniu-storage-tools"
            path: "qiniu-storage-tools"

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies for ${{ matrix.plugin.name }}
      run: |
        cd ${{ matrix.plugin.path }}
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Prepare test environment for ${{ matrix.plugin.name }}
      run: |
        cd ${{ matrix.plugin.path }}
        
        # æ¸…ç† __pycache__ æ–‡ä»¶
        find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
        find . -name "*.pyc" -delete 2>/dev/null || true
        
        echo "ðŸ“¦ Plugin directory contents:"
        ls -la

    - name: Test ${{ matrix.plugin.name }} runs without errors
      run: |
        cd ${{ matrix.plugin.path }}
        echo "ðŸ§ª Testing ${{ matrix.plugin.name }}..."
        timeout 10s python -m main || [ $? -eq 124 ]
        echo "âœ… ${{ matrix.plugin.name }} runs successfully"
