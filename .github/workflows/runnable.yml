name: Runnable

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
        package-type:
          - type: "ai"
            name: "qiniu-models"
            keep_models: true
            keep_tools: false
          - type: "kodo"
            name: "qiniu-tools"
            keep_models: false
            keep_tools: true
          - type: "all"
            name: "qiniu"
            keep_models: true
            keep_tools: true

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install yq for YAML processing
      run: |
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Prepare test environment for ${{ matrix.package-type.type }} package
      run: |
        # åˆ›å»ºæµ‹è¯•ç›®å½•
        mkdir -p /tmp/test-plugin
        # å¤åˆ¶æ–‡ä»¶ï¼ŒæŽ’é™¤ä¸éœ€è¦çš„ç›®å½•
        rsync -av --exclude='.git' --exclude='.github' --exclude='build.sh' --exclude='__pycache__' . /tmp/test-plugin/
        
        cd /tmp/test-plugin
        
        # æ›´æ–° manifest.yaml
        yq eval '.name = "${{ matrix.package-type.name }}"' -i manifest.yaml
        
        # æ ¹æ®ç±»åž‹åˆ é™¤ä¸éœ€è¦çš„æ–‡ä»¶å’Œé…ç½®
        if [ "${{ matrix.package-type.keep_models }}" = "false" ]; then
          echo "ðŸ—‘ï¸  åˆ é™¤æ¨¡åž‹ç›¸å…³æ–‡ä»¶..."
          rm -rf models/
          rm -f provider/qiniu_ai.py provider/qiniu_ai.yaml
          yq eval 'del(.plugins.models)' -i manifest.yaml
          yq eval '.resource.permission = {"tool": {"enabled": true}}' -i manifest.yaml
        fi
        
        if [ "${{ matrix.package-type.keep_tools }}" = "false" ]; then
          echo "ðŸ—‘ï¸  åˆ é™¤å·¥å…·ç›¸å…³æ–‡ä»¶..."
          rm -rf tools/
          rm -f provider/qiniu_tools.py provider/qiniu_tools.yaml
          yq eval 'del(.plugins.tools)' -i manifest.yaml
          yq eval '.resource.permission = {"model": {"llm": true, "rerank": false, "enabled": true, "moderation": false, "speech2text": false, "text_embedding": false, "tts": false}}' -i manifest.yaml
        fi
        
        # æ¸…ç†ç©ºçš„ provider ç›®å½•
        if [ -d provider ] && [ -z "$(ls -A provider)" ]; then
          rm -rf provider/
        fi
        
        # æ¸…ç† __pycache__ æ–‡ä»¶
        find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
        find . -name "*.pyc" -delete 2>/dev/null || true

    - name: Test ${{ matrix.package-type.type }} package runs without errors
      run: |
        cd /tmp/test-plugin
        echo "ðŸ§ª Testing ${{ matrix.package-type.name }} package..."
        timeout 10s python -m main || [ $? -eq 124 ]
        echo "âœ… ${{ matrix.package-type.name }} package runs successfully"
